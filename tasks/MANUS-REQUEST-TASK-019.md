# MANUS-REQUEST: TASK-019 WebSocket通信の強化

**Requested By**: Manus  
**Timestamp**: 2025-01-01  
**Priority**: High  
**Track**: server, mobile-app (並行実装)

---

## 指示

TASK-019（WebSocket通信の強化）を実装してください。

このタスクは **server** と **mobile-app** の両方のトラックに影響します。
Claude-1（mobile-app）とClaude-2（server）が並行して実装可能です。

## 前提条件

- ✅ TASK-011: サーバーサイドパーサーの強化 - 完了
- ✅ TASK-012: モバイルアプリ状態管理の刷新 - 完了

## 参照ドキュメント

1. **タスク仕様書**: `tasks/TASK-019-EPIC-10-WEBSOCKET-ENHANCEMENT.md`
2. **API設計書**: `docs/design/API_SPECIFICATION.md`
3. **データモデル設計書**: `docs/design/DATA_MODEL.md`
4. **データフロー設計書**: `docs/design/DATA_FLOW.md`

---

## Server-Side 実装 (Claude-2)

### ブランチ作成

```bash
git checkout develop
git pull origin develop
git checkout -b feature/server/task-019-websocket-enhancement
```

### 実装内容

#### 1. `progressParser.ts` の拡張

差分検出機能を追加してください：

```typescript
interface ProgressDiff {
  updatedTasks: Task[];
  newBlockers: Blocker[];
  resolvedBlockers: string[]; // blocker IDs
  hasStructuralChanges: boolean;
}

// 新しいメソッド
public parseProgressWithDiff(previousStatus: ProjectStatus | null): {
  status: ProjectStatus;
  diff: ProgressDiff;
}
```

#### 2. WebSocket Emitter の拡張

`src/server/src/websocket/index.ts` を更新：

```typescript
// 差分に基づいてイベントを発行
if (diff.updatedTasks.length > 0) {
  diff.updatedTasks.forEach(task => {
    io.emit('task_update', { task, timestamp: new Date().toISOString() });
  });
}

if (diff.newBlockers.length > 0) {
  diff.newBlockers.forEach(blocker => {
    io.emit('blocker_alert', { blocker, timestamp: new Date().toISOString() });
  });
}

// 構造的な変更がある場合のみ全体を送信
if (diff.hasStructuralChanges) {
  io.emit('project_status', { data: status, timestamp: new Date().toISOString() });
}
```

#### 3. ユニットテストの追加

差分検出のテストを追加してください（カバレッジ80%以上を維持）。

---

## Client-Side 実装 (Claude-1)

### ブランチ作成

```bash
git checkout develop
git pull origin develop
git checkout -b feature/mobile-app/task-019-websocket-enhancement
```

### 実装内容

#### 1. `useWebSocket.ts` の更新

新しいイベントハンドラを追加：

```typescript
// task_update イベント
newSocket.on('task_update', (data: { task: Task; timestamp: string }) => {
  console.log('Received task_update:', data);
  updateTask(data.task);
});

// blocker_alert イベント
newSocket.on('blocker_alert', (data: { blocker: Blocker; timestamp: string }) => {
  console.log('Received blocker_alert:', data);
  addBlocker(data.blocker);
});
```

#### 2. `dashboardStore.ts` の更新

新しいアクションを追加：

```typescript
interface DashboardActions {
  // 既存のアクション...
  updateTask: (task: Task) => void;
  addBlocker: (blocker: Blocker) => void;
  resolveBlocker: (blockerId: string) => void;
}

// 実装
updateTask: (task) => set((state) => {
  if (!state.projectStatus) return state;
  
  const updatedTracks = state.projectStatus.tracks.map(track => ({
    ...track,
    tasks: track.tasks.map(t => t.id === task.id ? task : t)
  }));
  
  return {
    projectStatus: {
      ...state.projectStatus,
      tracks: updatedTracks,
      lastUpdated: new Date().toISOString()
    }
  };
}),

addBlocker: (blocker) => set((state) => {
  if (!state.projectStatus) return state;
  
  return {
    projectStatus: {
      ...state.projectStatus,
      blockers: [...state.projectStatus.blockers, blocker],
      lastUpdated: new Date().toISOString()
    }
  };
}),
```

---

## 検証方法

### Server-Side

1. `progress.md` の単一タスクのステータスを変更
2. サーバーログで `task_update` イベントが発行されることを確認
3. 新しいブロッカーを追加
4. サーバーログで `blocker_alert` イベントが発行されることを確認

### Client-Side

1. モバイルアプリを起動
2. `progress.md` を変更
3. UIが部分的に更新されることを確認（全体リロードではない）

### 統合テスト

1. サーバーとクライアントを同時に起動
2. `progress.md` を変更
3. クライアントのUIがリアルタイムで更新されることを確認

---

## progress.md の更新

タスク完了後、`progress.md` を以下のように更新してください：

```markdown
| TASK-019 | server, mobile-app | WebSocket通信の強化 | ✅ Done | TASK-011, TASK-012 |
```

---

## 完了条件チェックリスト

### Server-Side
- [ ] `progressParser` に差分検出機能が追加されている
- [ ] `task_update` イベントが発行される
- [ ] `blocker_alert` イベントが発行される
- [ ] ユニットテストが追加されている（カバレッジ80%以上）
- [ ] TypeScriptコンパイルエラーがない

### Client-Side
- [ ] `useWebSocket` に新しいイベントハンドラが追加されている
- [ ] `dashboardStore` に `updateTask`, `addBlocker` アクションが追加されている
- [ ] UIが部分的に更新される
- [ ] TypeScriptコンパイルエラーがない

### 統合
- [ ] progress.md が更新されている
- [ ] PRが作成されている

---

🤖 Generated by Manus
